// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["interactiveTransactions"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User

model Email {
  id Int @id @default(autoincrement())

  user   User @relation(fields: [userId], references: [id])
  userId Int

  email     String  @unique
  primary   Boolean @default(false)
  confirmed Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model OldPasswords {
  id Int @id @default(autoincrement())

  user   User @relation(fields: [userId], references: [id])
  userId Int

  encryptedPassword String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, encryptedPassword])
}

model ApplicationSettings {
  id Int @id @default(autoincrement())

  user   User @relation(fields: [userId], references: [id])
  userId Int  @unique

  lang String @default("en")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model User {
  id Int @id @default(autoincrement())

  username          String    @unique
  encryptedPassword String
  creator           Boolean   @default(false)
  active            Boolean   @default(true)
  confirmed         Boolean   @default(false)
  firstName         String?
  lastName          String?
  birthday          DateTime?
  country           String?
  bio               Json

  emails       Email[]
  oldPasswords OldPasswords[]
  settings     ApplicationSettings?

  results                Result[]
  solutions              ChallengeSolution[]
  challengeSolutionVotes ChallengeSolutionVote[]
  comments               Comment[]
  commentVotes           CommentVote[]
  changes                Change[]
  mergeRequest           MergeRequest[]
  mergeRequestApprovals  MergeRequestApproval[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Changes

enum ChangeType {
  DEPARTMENT
  CHALLENGE
  COURSE
  CHAPTER
  LESSON
  LESSON_BLOCK
}

model Change {
  id Int @id @default(autoincrement())

  userId        Int
  user          User        @relation(fields: [userId], references: [id])
  prevChangeId  Int
  prevChange    Change?     @relation(name: "PrevChange", fields: [prevChangeId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  referenceId   Int
  referenceType ChangeType?

  latest Boolean
  name   String
  value  Json

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  prevChanges   Change[]       @relation(name: "PrevChange")
  mergeRequests MergeRequest[]

  @@unique([userId, referenceType, referenceId, prevChangeId])
}

model MergeRequest {
  id Int @id @default(autoincrement())

  user      User                   @relation(fields: [userId], references: [id])
  userId    Int
  change    Change                 @relation(fields: [changeId], references: [id])
  changeId  Int
  merged    Boolean                @default(false)
  approvals MergeRequestApproval[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([changeId])
}

model MergeRequestApproval {
  id Int @id @default(autoincrement())

  user           User         @relation(fields: [userId], references: [id])
  userId         Int
  mergeRequest   MergeRequest @relation(fields: [mergeRequestId], references: [id])
  mergeRequestId Int
  approved       Boolean      @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, mergeRequestId])
}

// Departments

model Department {
  id Int @id @default(autoincrement())

  name        String
  url         String @unique
  logo        Asset? @relation(name: "DepartmentLogo", fields: [logoId], references: [id])
  logoId      Int?
  description Json

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  challenges Challenge[]
  assets     Asset[]
  Course     Course[]
}

// Challenges

enum QuestionType {
  MULTIPLE_CHOICE
  INPUT
  FLASH_CARD
  MARK_AS_READ
}

model Challenge {
  id Int @id @default(autoincrement())

  logo         Asset?     @relation(name: "ChallengeLogo", fields: [logoId], references: [id])
  logoId       Int?
  department   Department @relation(fields: [departmentId], references: [id])
  departmentId Int

  name        String
  url         String
  description Json
  type        QuestionType @default(MULTIPLE_CHOICE)
  prompt      Json

  results   Result[]            @relation(name: "ChallengeResult")
  solutions ChallengeSolution[]

  visible    Boolean   @default(false)
  releasedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([departmentId, url])
}

model ChallengeSolution {
  id Int @id @default(autoincrement())

  challengeId Int
  challenge   Challenge @relation(fields: [challengeId], references: [id])
  userId      Int
  user        User      @relation(fields: [userId], references: [id])

  solution Json

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  votes ChallengeSolutionVote[]

  @@unique([userId, challengeId])
}

model ChallengeSolutionVote {
  id                  Int               @id @default(autoincrement())
  challengeSolutionId Int
  challengeSolution   ChallengeSolution @relation(fields: [challengeSolutionId], references: [id])
  userId              Int
  user                User              @relation(fields: [userId], references: [id])

  vote Boolean?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, challengeSolutionId])
}

// Comments

enum CommentReferenceType {
  CHALLENGE_SOLUTION
  CHALLENGE_DRAFT
  CHALLENGE
}

model Comment {
  id Int @id @default(autoincrement())

  referenceType CommentReferenceType @default(CHALLENGE_SOLUTION)
  referenceId   Int
  commentId     Int?
  comment       Comment?             @relation(name: "Comments", fields: [commentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  userId        Int
  user          User                 @relation(fields: [userId], references: [id])

  content Json
  deleted Boolean @default(false)

  votes    CommentVote[]
  comments Comment[]     @relation(name: "Comments")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([referenceType, referenceId, commentId])
}

model CommentVote {
  id Int @id @default(autoincrement())

  commentId Int
  comment   Comment @relation(fields: [commentId], references: [id])
  userId    Int
  user      User    @relation(fields: [userId], references: [id])

  vote Boolean?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, commentId])
}

model Result {
  id Int @id @default(autoincrement())

  user          User         @relation(fields: [userId], references: [id])
  userId        Int
  challenge     Challenge?   @relation(name: "ChallengeResult", fields: [challengeId], references: [id])
  challengeId   Int
  lessonBlock   LessonBlock? @relation(name: "LessonBlockResult", fields: [lessonBlockId], references: [id])
  lessonBlockId Int

  type   QuestionType @default(MULTIPLE_CHOICE)
  prompt Json
  answer Json?
  value  Float

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Assets

enum AssetType {
  IMAGE
  VIDEO
  AUDIO
}

model Asset {
  id Int @id @default(autoincrement())

  department   Department @relation(fields: [departmentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  departmentId Int

  type   AssetType
  name   String
  folder String

  departmentLogos Department[] @relation(name: "DepartmentLogo")
  challengeLogos  Challenge[]  @relation(name: "ChallengeLogo")
  courseLogos     Course[]     @relation(name: "CourseLogo")
  chapterLogos    Chapter[]    @relation(name: "ChapterLogo")
  lessonLogos     Lesson[]     @relation(name: "LessonLogo")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([departmentId, folder, name])
}

// Courses

model Course {
  id Int @id @default(autoincrement())

  logo         Asset?     @relation(name: "CourseLogo", fields: [logoId], references: [id])
  logoId       Int?
  department   Department @relation(fields: [departmentId], references: [id])
  departmentId Int

  name        String
  url         String
  description Json

  visible    Boolean   @default(false)
  releasedAt DateTime?

  chapters Chapter[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([departmentId, url])
}

model Chapter {
  id Int @id @default(autoincrement())

  logo     Asset? @relation(name: "ChapterLogo", fields: [logoId], references: [id])
  logoId   Int
  course   Course @relation(fields: [courseId], references: [id])
  courseId Int
  index    Int    @default(0)

  name        String
  url         String
  description Json

  visible    Boolean   @default(false)
  releasedAt DateTime?

  lessons  Lesson[]
  quizzies Quiz[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([courseId, url])
}

model Quiz {
  id Int @id @default(autoincrement())

  chapter   Chapter @relation(fields: [chapterId], references: [id])
  chapterId Int
  config    Json

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Lesson {
  id Int @id @default(autoincrement())

  logo      Asset?  @relation(name: "LessonLogo", fields: [logoId], references: [id])
  logoId    Int
  chapter   Chapter @relation(fields: [chapterId], references: [id])
  chapterId Int
  index     Int     @default(0)

  name         String
  url          String
  description  Json
  lessonBlocks LessonBlock[]

  visible    Boolean   @default(false)
  releasedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([chapterId, url])
}

model LessonBlock {
  id Int @id @default(autoincrement())

  lesson   Lesson @relation(fields: [lessonId], references: [id])
  lessonId Int
  index    Int    @default(0)

  name        String
  url         String
  description Json
  type        QuestionType @default(MULTIPLE_CHOICE)
  prompt      Json

  results Result[] @relation(name: "LessonBlockResult")

  visible    Boolean   @default(false)
  releasedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([lessonId, url])
}
